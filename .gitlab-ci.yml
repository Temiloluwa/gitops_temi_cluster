default:
  image:
    name: amazon/aws-cli
    entrypoint: [""]

variables:
  DESTROY: "false"

cache:
  paths:
    - .terraform
    - ./

before_script:
  - yum install -y yum-utils
  - yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
  - yum -y install terraform
  - aws --version
  - echo "confirm user access to s3"
  - echo "$AWS_ACCESS_KEY_ID"
  - aws s3 ls
  - cd iac
  - terraform --version
  - terraform init


stages:
  - plan
  - apply
  - destroy

plan-job:
  stage: plan
  script:
    - ls -lah
    - terraform plan

apply-job:
  stage: apply
  script:
    - ls -lah
    - terraform apply -var="keypair_content=$keypair_content" -auto-approve

destroy-job:
  stage: destroy
  script:
    - ls -lah
    - terraform destroy -auto-approve
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $DESTROY == "true"
      when: on_success
